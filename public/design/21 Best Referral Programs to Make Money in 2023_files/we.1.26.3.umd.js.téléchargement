var __accessCheck=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)},__privateGet=(e,t,r)=>(__accessCheck(e,t,"read from private field"),r?r.call(e):t.get(e)),__privateAdd=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},__privateSet=(e,t,r,i)=>(__accessCheck(e,t,"write to private field"),i?i.call(e,r):t.set(e,r),r),__privateMethod=(e,t,r)=>(__accessCheck(e,t,"access private method"),r);!function(e){!function(e){var t,r,i,n,s,o,a,c;"use strict";class u{constructor(){this.visitorFlow=[]}addEntry(e){this.visitorFlow.push(e)}hasElementBeenVisited(e){return!!this.visitorFlow.find((t=>t===e))}}var l=(e=>(e["AwaitClick"]="await_click",e["AwaitScroll"]="await_scroll",e["AwaitExit"]="await_exit",e["AwaitInactivity"]="await_inactivity",e["FilterUrl"]="filter_url",e["FilterSubscriber"]="filter_subscriber",e["FilterDevice"]="filter_device",e["FilterLocation"]="filter_location",e["FilterTime"]="filter_time",e["FilterVisit"]="filter_visit",e["FilterPopup"]="filter_popup",e["FilterECommerceActivity"]="filter_ecommerce_activity",e["ReactDelay"]="react_delay",e["ReactScroll"]="react_scroll",e["ReactRedirect"]="react_redirect",e["ReactPopup"]="react_popup",e))(l||{});class d extends Error{}const p="true",h="false";class g extends ReferenceError{constructor(e){super(`Node of selector ${e} not found`)}}class v{constructor({id:e,isRecurrent:t,properties:r}){this.id=e,this.isRecurrent=t,this.properties=r}}class w extends v{constructor(){super(...arguments),this.leaveFalseTimeout=null}waitForDelayLeaveFalse(){return new Promise((e=>{const{leaveFalseDelay:t}=this.properties;if(t)this.leaveFalseTimeout=window.setTimeout(e,t)}))}cleanLeaveFalseTimeout(){if(this.leaveFalseTimeout)window.clearTimeout(this.leaveFalseTimeout),this.leaveFalseTimeout=null}}const y="_grDebugMode",m=new class{isDebugEnabled(){return!!window.sessionStorage.getItem(y)}startDebug(){window.sessionStorage.setItem(y,"true")}},f=new class{get isLoggingEnabled(){return m.isDebugEnabled()}log(...e){this.displayLog("log",...e)}info(...e){this.displayLog("info",...e)}error(...e){this.displayLog("error",...e)}warn(...e){this.displayLog("warn",...e)}displayLog(e,...t){if(this.isLoggingEnabled)console[e](...t)}},D=100;if(false){if("undefined"!=typeof navigator&&"ReactNative"===navigator.product&&"undefined"==typeof crypto)throw new Error("React Native does not have a built-in secure random generator. If you don’t need unpredictable IDs use `nanoid/non-secure`. For secure IDs, import `react-native-get-random-values` before Nano ID.");if("undefined"!=typeof msCrypto&&"undefined"==typeof crypto)throw new Error("Import file with `if (!window.crypto) window.crypto = window.msCrypto` before importing Nano ID to fix IE 11 support");if("undefined"==typeof crypto)throw new Error("Your browser does not have secure random generator. If you don’t need unpredictable IDs, you can use nanoid/non-secure.")}function E(e){const t=document.cookie.match(new RegExp(`(^| )${e}=([^;]+)`));if(t)return t[2]}var P=(e=>(e["UuidHasBeenSet"]="grUuidHasBeenSet",e["PopupsRendererCustomUrl"]="grPopupsRendererCustomUrl",e))(P||{});class I{constructor(){__privateAdd(this,t,new Proxy({},{get(e,t){if(t in e)return e[t];else return e[t]=[],e[t]}}))}addEvent(e,r){__privateGet(this,t)[e].push(r)}drainEvents(e){const r=__privateGet(this,t)[e];return __privateGet(this,t)[e]=[],r}hasDelayedEvents(e){return __privateGet(this,t)[e].length>0}}t=new WeakMap,r=new WeakMap,i=new WeakMap;const S=new class{constructor(){__privateAdd(this,r,{}),__privateAdd(this,i,new I)}publish(e,...t){var n;let s=false;if(null==(n=__privateGet(this,r)[e])?void 0:n.length)__privateGet(this,r)[e].forEach((r=>{if(s)f.error(`More than one subscriber is listening on event ${e}`);else r(...t),s=true,f.log(`Event ${e} published with arguments'`,...t)}));else __privateGet(this,i).addEvent(e,t)}subscribe(e,t){if(!__privateGet(this,r)[e])__privateGet(this,r)[e]=[];if(__privateGet(this,i).hasDelayedEvents(e))__privateGet(this,i).drainEvents(e).forEach((e=>t(...e)));__privateGet(this,r)[e].push(t)}unsubscribe(e,t){var i;const n=null==(i=__privateGet(this,r)[e])?void 0:i.indexOf(t);if(n>-1)__privateGet(this,r)[e].splice(n,1)}removeListeners(e){delete __privateGet(this,r)[e]}},b=new class{initialize(e){const{xsid:t,grid:r,domain:i,aid:n,useNOStorage:s,useBetterSubscriberIdentification:o,isServedFromCustomDomain:a,scriptsDomain:c,scriptsVersion:u,tracking:l}=e;window.__grIntegrationConfig=window.__grIntegrationConfig||{cData:{aid:n,grid:r,domain:i,useNOStorage:s,useBetterSubscriberIdentification:o,isServedFromCustomDomain:a},visitor:{email:null,eComId:null,xsid:t},tracking:{isEnabled:l},webEvents:{isModuleInitialized:false},webPush:{customSwPath:null,wpid:null,pushDomain:null,promptEndpoint:null},analyticsData:{scriptsDomain:c,scriptsVersion:u},eventBus:S}}isWebEventModuleInitialized(){return window.__grIntegrationConfig.webEvents.isModuleInitialized??false}setWebEventModuleInitialized(){if(false===window.__grIntegrationConfig.webEvents.isModuleInitialized)window.__grIntegrationConfig.webEvents.isModuleInitialized=true}canUseBackendForSubscriberIdentification(){return window.__grIntegrationConfig.cData.useBetterSubscriberIdentification}getUserAid(){return window.__grIntegrationConfig.cData.aid}getUserAnalyticsDomain(){return window.__grIntegrationConfig.cData.domain}enablePopupDevMode(){window.__grIntegrationConfig.setCustomPopupRendererUrl=e=>{window.sessionStorage.setItem(P.PopupsRendererCustomUrl,e)}}getPopupRendererCustomUrl(){return window.sessionStorage.getItem(P.PopupsRendererCustomUrl)}setCustomSwPath(e){if("string"!=typeof e)throw new Error("Path type must be string");if(!e.match(/gr_sw_main.js$/))throw new Error("Invalid sw file name");window.__grIntegrationConfig.webPush.customSwPath=e}getCustomSwPath(){var e;return null==(e=window.__grIntegrationConfig)?void 0:e.webPush.customSwPath}isTrackingEnabled(){return window.__grIntegrationConfig.tracking.isEnabled}isTrackingScriptServedFromCustomDomain(){return window.__grIntegrationConfig.cData.isServedFromCustomDomain}set visitorEmail(e){window.__grIntegrationConfig.visitor.email=e}get visitorEmail(){return window.__grIntegrationConfig.visitor.email}get pushWpid(){return window.__grIntegrationConfig.webPush.wpid}set pushWpid(e){window.__grIntegrationConfig.webPush.wpid=e}set pushDomain(e){window.__grIntegrationConfig.webPush.pushDomain=e}get pushDomain(){return window.__grIntegrationConfig.webPush.pushDomain}set pushPromptEndpoint(e){window.__grIntegrationConfig.webPush.promptEndpoint=e}get pushPromptEndpoint(){return window.__grIntegrationConfig.webPush.promptEndpoint}get eventBus(){return window.__grIntegrationConfig.eventBus}get canUseBackendStorageForEvents(){return window.__grIntegrationConfig.cData.useNOStorage}get webConnectScriptCdnUrl(){return window.__grIntegrationConfig.analyticsData.scriptsDomain}get webConnectCurrentScriptsVersion(){return window.__grIntegrationConfig.analyticsData.scriptsVersion}};var C,T;(T=C||(C={}))["PageVisit"]="visit",T["Popup"]="popup",T["ViewItem"]="view_item",T["ViewCategory"]="view_category",T["WishlistItem"]="wishlist_item",T["LikeItem"]="like_item",void(T["ShopifyAbandonedCart"]="shopify_webhook_abandoned_cart");class _ extends Error{constructor(e){super(e),Object.setPrototypeOf(this,new.target.prototype),this.name=this.constructor.name}}class A extends _{constructor(e){super(e)}}const F={cartToken:"string",urlToken:"string",visitorEmail:"string"},L=["cartToken","urlToken"];var V,O,U,N,k;function R(e,t){const r=e.isTextResponse??(null==t?void 0:t.isTextResponse);return fetch(e,{...t,headers:{...null==t?void 0:t.headers,[U.UserAid]:b.getUserAid()}}).then((async e=>{if(e.ok)return r?e.text():e.json();const t=await e.text();return Promise.reject({statusCode:e.status,message:t})}))}(k=V||(V={}))["Inline"]="inline",void(k["Popup"]="popup"),(N=O||(O={}))["Hq"]="Hq",void(N["Us"]="Us"),void((U||(U={}))["UserAid"]="X-Aid");var x=(e=>(e["visitorUuid"]="gaVisitorUuid",e["visitorValuable"]="gaIsValuable",e["VisitorResubscribed"]="gaVisitorResubscribed",e))(x||{});const B=new class{getVisitorData(){return R(new URL(`visitors/${b.getUserAid()}/${E(x.visitorUuid)}`,b.getUserAnalyticsDomain()).href)}},$=1e3*60*60*24;function W(e,t){const r=new Date(e+t*$),i=new Date(r.getFullYear(),r.getMonth(),r.getDate(),0,0,0);return Date.now()>=Date.parse(i.toString())}class M extends Error{constructor(e){super(e),Object.setPrototypeOf(this,new.target.prototype),this.name=this.constructor.name}}class j extends M{}var J,q,G,z,H,K,Y,X,Q,Z,ee,te,re,ie,ne,se,oe,ae,ce,ue,le,de,pe,he,ge,ve,we,ye,me,fe,De,Ee=(e=>(e[e["Mobile"]=480]="Mobile",e[e["Tablet"]=768]="Tablet",e))(Ee||{});(De=J||(J={}))["ShowWhenCondition"]="showWhenCondition",De["VisitorsCondition"]="visitors",De["DeviceCondition"]="device",De["LocationCondition"]="location",De["ECommerceCondition"]="ecommerce",De["TriggerFrequency"]="frequency",De["PreventDisplay"]="preventDisplay",void(De["DateRange"]="dateRange"),(fe=q||(q={}))["Mobile"]="mobile",fe["Tablet"]="tablet",void(fe["Desktop"]="desktop"),(me=G||(G={}))["All"]="all",me["New"]="new",void(me["Returning"]="returning"),void((z||(z={}))["All"]="all"),(ye=H||(H={}))["ConditionsLogicSeparator"]="conditionsLogicSeparator",void(ye["ECommerceConditions"]="ecommerceConditions"),(we=K||(K={}))["Amount"]="amount",void(we["Date"]="date"),(ve=Y||(Y={}))["And"]="and",void(ve["Or"]="or"),(ge=X||(X={}))["Exactly"]="exactly",ge["LessThan"]="lessThan",void(ge["MoreThan"]="moreThan"),(he=Q||(Q={}))["LastDays"]="lastDays",void(he["DateRange"]="dateRange"),(pe=Z||(Z={}))["AnyProduct"]="any",void(pe["AnyCategory"]="any"),(de=ee||(ee={}))["Category"]="category",void(de["Product"]="product"),(le=te||(te={}))["Percent"]="percent",void(le["Selector"]="selector"),(ue=re||(re={}))["Instantly"]="instantly",ue["Delay"]="delay",ue["Exit"]="exit",ue["Scroll"]="scroll",void(ue["Inactivity"]="inactivity"),(ce=ie||(ie={}))["AfterSubmit"]="submit",ce["AfterClose"]="close",void(ce["AfterTimes"]="timesAmount"),(ae=ne||(ne={}))["Always"]="always",ae["Session"]="session",void(ae["EveryDays"]="everyDays"),(oe=se||(se={}))[oe["InvalidCssSelector"]=1]="InvalidCssSelector",oe[oe["EmptyCssSelector"]=2]="EmptyCssSelector",oe[oe["CssSelectorTooLong"]=3]="CssSelectorTooLong",oe[oe["CssInvalidType"]=4]="CssInvalidType",oe[oe["InvalidTimeoutProperty"]=5]="InvalidTimeoutProperty",oe[oe["ShowWhenScrollPercentInvalidValueType"]=6]="ShowWhenScrollPercentInvalidValueType",oe[oe["ShowWhenScrollPercentValueOutOfBound"]=7]="ShowWhenScrollPercentValueOutOfBound",oe[oe["VisitorTriggerEmpty"]=8]="VisitorTriggerEmpty",oe[oe["VisitorTriggerInvalidProperty"]=9]="VisitorTriggerInvalidProperty",oe[oe["DevicesTriggerEmpty"]=10]="DevicesTriggerEmpty",oe[oe["DevicesTriggerInvalidValue"]=11]="DevicesTriggerInvalidValue",oe[oe["FrequencyEmptyTrigger"]=12]="FrequencyEmptyTrigger",oe[oe["FrequencyTriggerInvalidName"]=13]="FrequencyTriggerInvalidName",oe[oe["FrequencyTriggerNDaysInvalidPropertyValue"]=14]="FrequencyTriggerNDaysInvalidPropertyValue",oe[oe["FrequencyTriggerNDaysEmptyValue"]=15]="FrequencyTriggerNDaysEmptyValue",oe[oe["PreventDisplayTriggerInvalidName"]=16]="PreventDisplayTriggerInvalidName",oe[oe["PreventDisplayTriggerAfterTimesNoValue"]=17]="PreventDisplayTriggerAfterTimesNoValue",oe[oe["PreventDisplayTriggerAfterTimesInvalidValue"]=18]="PreventDisplayTriggerAfterTimesInvalidValue",oe[oe["DateRangeInvalidFromDate"]=19]="DateRangeInvalidFromDate",oe[oe["DateRangeInvalidToDate"]=20]="DateRangeInvalidToDate",oe[oe["DateRangeDateFromAfterDateTo"]=21]="DateRangeDateFromAfterDateTo",oe[oe["DateRangeToBeforeCurrentTime"]=22]="DateRangeToBeforeCurrentTime",oe[oe["LocationEmptyTrigger"]=23]="LocationEmptyTrigger",oe[oe["LocationInvalidType"]=24]="LocationInvalidType",oe[oe["LackOfLogicSeparator"]=25]="LackOfLogicSeparator",oe[oe["LackOfTriggerConditions"]=26]="LackOfTriggerConditions",oe[oe["InvalidTriggerConditions"]=27]="InvalidTriggerConditions",oe[oe["NoProductOrCategorySelected"]=28]="NoProductOrCategorySelected",oe[oe["ProductInvalidType"]=29]="ProductInvalidType",oe[oe["CategoryInvalidType"]=30]="CategoryInvalidType",oe[oe["AmountInvalidConditionName"]=31]="AmountInvalidConditionName",oe[oe["AmountInvalidConditionValueType"]=32]="AmountInvalidConditionValueType",oe[oe["DateInvalidConditionName"]=33]="DateInvalidConditionName",oe[oe["DateLastDaysInvalidConditionValue"]=34]="DateLastDaysInvalidConditionValue",oe[oe["DateDateRangeInvalidConditionValue"]=35]="DateDateRangeInvalidConditionValue",oe[oe["DateDateRangeFromInvalidValue"]=36]="DateDateRangeFromInvalidValue",oe[oe["DateDateRangeToInvalidValue"]=37]="DateDateRangeToInvalidValue",oe[oe["DateDateRangeDateFromAfterDateTo"]=38]="DateDateRangeDateFromAfterDateTo",void(oe[oe["PopupTriggerInvalidName"]=39]="PopupTriggerInvalidName");const Pe=new class{getVisitorCountryCode(){const{domain:e}=window.__grIntegrationConfig.cData;return fetch(`${e}web-user-data/country`).then((e=>e.text()))}},Ie=400;class Se extends M{constructor(){super("Invalid time properties")}}var be=(e=>(e["Always"]="always",e["OnceEveryDays"]="xDays",e["Session"]="everySession",e))(be||{});const Ce=new class{constructor(){this.uuid=E(x.visitorUuid)}hasUserVisitedPage(){return this.getSessionVisitData().count>1}saveUserVisit(){const e=this.getSessionVisitData()||{count:0};sessionStorage.setItem("gaUserPageSessionVisit",JSON.stringify({...e,count:e.count+1}))}getSessionVisitData(){return JSON.parse(sessionStorage.getItem("gaUserPageSessionVisit"))}};class Te extends M{constructor(){super("Failed to parse data from JSON string")}}var _e=(e=>(e["Show"]="show",e["Close"]="close",e["Submit"]="submit",e))(_e||{});const Ae=new class{constructor(){this.timer=Date.now()}getCurrentVisitOnPageTime(){return Date.now()-this.timer}};class Fe{constructor(e){this.eventType=e,this.aid=window.__grIntegrationConfig.cData.aid,this.grid=window.__grIntegrationConfig.cData.grid,this.time=Ae.getCurrentVisitOnPageTime(),this.uuid=E(x.visitorUuid),this.url=window.location.href,this.occurredOn=new Date}get externalUid(){const{xsid:e,email:t,eComId:r}=window.__grIntegrationConfig.visitor;return r||e||t}toJSON(){return{aid:this.aid,grid:this.aid,uuid:this.uuid,externalUid:this.externalUid,time:this.time,url:this.url,eventType:this.eventType,occurredOn:this.occurredOn.toUTCString()}}toString(){return JSON.stringify(this.toJSON())}}class Le extends Fe{constructor(e,t){super(C.Popup),this.popupEvent=e,this.popupId=t}toJSON(){return{...super.toJSON(),popupId:this.popupId,popupEvent:this.popupEvent}}}class Ve extends Fe{toJSON(){return{...super.toJSON(),data:this.data}}}class Oe extends Ve{constructor(e){super(C.ViewItem),this.data=e}}class Ue extends Fe{constructor(e){super(C.ViewCategory),this.data=e}toJSON(){return{...super.toJSON(),data:this.data}}}class Ne extends Ve{constructor(e){super(C.WishlistItem),this.data=e}}class ke extends Ve{constructor(e){super(C.LikeItem),this.data=e}}class Re extends Fe{constructor(e){super(C.ShopifyAbandonedCart),this.data=e}toJSON(){return{...super.toJSON(),data:this.data}}}const xe=class{static getPageVisitEvent(){return new Fe(C.PageVisit)}static getPopupSubmitEvent(e){return new Le(_e.Submit,e)}static getPopupShowEvent(e){return new Le(_e.Show,e)}static getPopupCloseEvent(e){return new Le(_e.Close,e)}static getViewItemEvent(e){var t;return new Oe(__privateMethod(t=xe,n,s).call(t,e))}static getWishlistItemEvent(e){var t;return new Ne(__privateMethod(t=xe,n,s).call(t,e))}static getLikeItemEvent(e){var t;return new ke(__privateMethod(t=xe,n,s).call(t,e))}static getViewCategoryEvent(e){const{name:t,id:r}=e;return new Ue({id:r,...t&&{name:t}})}static getShopifyIntegrationAbandonedCartEvent(e){try{return(e=>{if("object"!=typeof e||null===e)throw new A("Invalid data parameter type");else{const t=Object.entries(F),r=Object.keys(e);if(!L.every((e=>r.includes(e))))throw new A("Lack of required parameters");if(!t.every((([t,r])=>!e[t]||typeof e[t]===r)))throw new A("Properties have invalid type")}return true})(e),new Re((t=e,r=Object.keys(F),Object.entries(t).reduce(((e,[t,i])=>{if(r.includes(t))e[t]=i;return e}),{})))}catch(i){return f.error(i),null}var t,r}};let Be=xe;n=new WeakSet,s=e=>{const{product:t,categories:r}=e,i=["id","sku","name","vendor","price","currency"],n=["id","name"],s={product:{}};if(!t.id)f.error("Missing required param");if(Object.keys(t).forEach((e=>{if(i.includes(e))s.product[e]=t[e]})),Array.isArray(r))s.categories=r.map((e=>{const t={};if(Object.keys(e).forEach((r=>{if(n.includes(r))t[r]=e[r]})),t.id)return t;else return null})).filter(Boolean);return s},__privateAdd(Be,n);class $e{static sendJSON(e,t){navigator.sendBeacon(e,new Blob([JSON.stringify({...JSON.parse(t),[U.UserAid]:b.getUserAid()})],{type:"application/json"}))}}const We=new class{constructor(){this.popupsCachedData={}}sendPageVisitEvent(e){$e.sendJSON(new URL("activity/event",b.getUserAnalyticsDomain()).href,e.toString())}getUserLastActivityDate(){const e=b.getUserAid();return R(new URL(`activity/session/${e}/${E(x.visitorUuid)}`,b.getUserAnalyticsDomain()).href)}async addPopupEventToStorage(e){$e.sendJSON(new URL("activity/event",b.getUserAnalyticsDomain()).href,JSON.stringify(e.toJSON()))}async getPopupActivityData(e){if(this.popupsCachedData)return this.popupsCachedData;const t=b.getUserAid();return this.popupsCachedData=await R(new URL(`activity/popups/${t}/${E(x.visitorUuid)}/${e}`,b.getUserAnalyticsDomain()).href),this.popupsCachedData}async saveECommerceEventToStorage(e){$e.sendJSON(new URL("activity/event",b.getUserAnalyticsDomain()).href,JSON.stringify(e.toJSON()))}},Me=new class{async isNewVisitor(){return!(await this.getLastActivityDate())}getLastActivityDate(){const{useNOStorage:e}=window.__grIntegrationConfig.cData;return e?this.getLastActivityDateFromBackendStorage():this.getLastActivityDateFromBrowserStorage()}async getLastActivityDateFromBackendStorage(){const e=await We.getUserLastActivityDate();if(null==e?void 0:e.lastActivity)return new Date(e.lastActivity)}getLastActivityDateFromBrowserStorage(){var e;const t=E(x.visitorUuid),r=localStorage.getItem("gaLocalStorageVisitKey");let i;try{i=JSON.parse(r)}catch{throw new Te}if(null==i?void 0:i[t])return Promise.resolve(new Date(null==(e=i[t])?void 0:e.lastActivity));else return null}saveUserActivity(){return window.__grIntegrationConfig.cData.useNOStorage?this.saveUserActivityToBackendStorage():this.saveUserActivityToBrowserStorage()}saveUserActivityToBackendStorage(){We.sendPageVisitEvent(Be.getPageVisitEvent())}saveUserActivityToBrowserStorage(){const e={[E(x.visitorUuid)]:{lastActivity:Be.getPageVisitEvent().occurredOn.toUTCString()}};try{window.localStorage.setItem("gaLocalStorageVisitKey",JSON.stringify(e))}catch{throw new Te}}},je=new Map,Je=(e,t)=>{if(!Array.isArray(e))switch(typeof e){case"string":e=[e];break;case"undefined":e=[];break;default:throw new TypeError(`Expected '${t}' to be a string or an array, but got a type of '${typeof e}'`)}return e.filter((e=>{if("string"!=typeof e){if(void 0===e)return false;throw new TypeError(`Expected '${t}' to be an array of strings, but found a type of '${typeof e}' in the array`)}return true}))};function qe(e,t,r){return((e,t,r,i)=>{if(e=Je(e,"inputs"),0===(t=Je(t,"patterns")).length)return[];t=t.map((e=>((e,t)=>{t={caseSensitive:false,...t};const r=e+JSON.stringify(t);if(je.has(r))return je.get(r);const i="!"===e[0];if(i)e=e.slice(1);e=(e=>{if("string"!=typeof e)throw new TypeError("Expected a string");return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d")})(e).replace(/\\\*/g,"[\\s\\S]*");const n=new RegExp(`^${e}$`,t.caseSensitive?"":"i");return n.negated=i,je.set(r,n),n})(e,r)));const{allPatterns:n}=r||{},s=[];for(const o of e){let e;const r=[...t].fill(false);for(const[i,n]of t.entries())if(n.test(o))if(r[i]=true,e=!n.negated,!e)break;if(!(false===e||void 0===e&&t.some((e=>!e.negated))||n&&r.some(((e,r)=>!e&&!t[r].negated))))if(s.push(o),i)break}return s})(e,t,r,true).length>0}var Ge=(e=>(e["Events"]="gr_webconnect",e))(Ge||{});const ze={gr_webconnect:1};var He=(e=>(e["UserActivityEvents"]="user_activity_events",e))(He||{}),Ke=(e=>(e["EventType"]="eventType",e["VisitorUuid"]="visitorUuid",e["EventTypeWithVisitor"]="eventType, visitorUuid",e))(Ke||{});let Ye,Xe;const Qe=new WeakMap,Ze=new WeakMap,et=new WeakMap,tt=new WeakMap,rt=new WeakMap;let it={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return Ze.get(e);if("objectStoreNames"===t)return e.objectStoreNames||et.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return st(e[t])},set:(e,t,r)=>(e[t]=r,true),has(e,t){if(e instanceof IDBTransaction&&("done"===t||"store"===t))return true;else return t in e}};function nt(e){if("function"==typeof e)return function(e){if(e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype))return function(t,...r){const i=e.call(ot(this),t,...r);return et.set(i,t.sort?t.sort():[t]),st(i)};if((Xe||(Xe=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e))return function(...t){return e.apply(ot(this),t),st(Qe.get(this))};else return function(...t){return st(e.apply(ot(this),t))}}(e);if(e instanceof IDBTransaction)!(e=>{if(Ze.has(e))return;const t=new Promise(((t,r)=>{const i=()=>{e.removeEventListener("complete",n),e.removeEventListener("error",s),e.removeEventListener("abort",s)},n=()=>{t(),i()},s=()=>{r(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",n),e.addEventListener("error",s),e.addEventListener("abort",s)}));Ze.set(e,t)})(e);if(t=e,(Ye||(Ye=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>t instanceof e)))return new Proxy(e,it);else return e;var t}function st(e){if(e instanceof IDBRequest)return(e=>{const t=new Promise(((t,r)=>{const i=()=>{e.removeEventListener("success",n),e.removeEventListener("error",s)},n=()=>{t(st(e.result)),i()},s=()=>{r(e.error),i()};e.addEventListener("success",n),e.addEventListener("error",s)}));return t.then((t=>{if(t instanceof IDBCursor)Qe.set(t,e)})).catch((()=>{})),rt.set(t,e),t})(e);if(tt.has(e))return tt.get(e);const t=nt(e);if(t!==e)tt.set(e,t),rt.set(t,e);return t}const ot=e=>rt.get(e),at=["get","getKey","getAll","getAllKeys","count"],ct=["put","add","delete","clear"],ut=new Map;function lt(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&"string"==typeof t))return;if(ut.get(t))return ut.get(t);const r=t.replace(/FromIndex$/,""),i=t!==r,n=ct.includes(r);if(!(r in(i?IDBIndex:IDBObjectStore).prototype)||!(n||at.includes(r)))return;const s=async function(e,...t){const s=this.transaction(e,n?"readwrite":"readonly");let o=s.store;if(i)o=o.index(t.shift());return(await Promise.all([o[r](...t),n&&s.done]))[0]};return ut.set(t,s),s}var dt;dt=it,void(it={...dt,get(e,t,r){return lt(e,t)||dt.get(e,t,r)},has(e,t){return!!lt(e,t)||dt.has(e,t)}});const pt=new class{openEventsDatabaseConnection(e){return this.openConnection(Ge.Events,ze[Ge.Events],e)}async openConnection(e,t,r){const i=await((e,t,{blocked:r,upgrade:i,blocking:n,terminated:s}={})=>{const o=indexedDB.open(e,t),a=st(o);if(i)o.addEventListener("upgradeneeded",(e=>{i(st(o.result),e.oldVersion,e.newVersion,st(o.transaction),e)}));if(r)o.addEventListener("blocked",(e=>r(e.oldVersion,e.newVersion,e)));return a.then((e=>{if(s)e.addEventListener("close",(()=>s()));if(n)e.addEventListener("versionchange",(e=>n(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),a})(e,t,{blocked(e,t,r){f.error(`Connection to old db version: ${t} not closed. Version ${e} not available`,r)},upgrade(e,t,i){f.log(`New db version ${i} detected, upgrading from ${t}`),r(t,i,e)},terminated(){f.log("Closing db connection")},blocking(e,t,r){f.log(`Current connection od db version ${e} is blocking connection to version ${t}.`,r),i.close()}});return i}};o=new WeakSet,a=(e,t,r)=>{if(0===e&&1===t)!(e=>{if(!e.objectStoreNames.contains(He.UserActivityEvents))try{const t=e.createObjectStore(He.UserActivityEvents,{keyPath:"id",autoIncrement:true});t.createIndex(Ke.EventType,"eventType",{unique:false}),t.createIndex(Ke.VisitorUuid,"uuid",{unique:false}),t.createIndex(Ke.EventTypeWithVisitor,["eventType","uuid"])}catch(t){f.error("Error while initializing/upgrading database",t)}})(r)};const ht=new class{constructor(){__privateAdd(this,o)}async saveEvent(e){const t=e instanceof Fe?e.toJSON():e;try{const e=(await pt.openEventsDatabaseConnection(__privateMethod(this,o,a))).transaction(He.UserActivityEvents,"readwrite"),r=e.objectStore(He.UserActivityEvents);await r.add(t),await e.done}catch(r){f.error("Error while saving event to database",r)}}async getEvents(e){const t=E(x.visitorUuid);try{const r=(await pt.openEventsDatabaseConnection(__privateMethod(this,o,a))).transaction(He.UserActivityEvents,"readwrite"),i=r.objectStore(He.UserActivityEvents).index(Ke.EventTypeWithVisitor),n=await i.getAll([e,t]);return await r.done,n}catch(r){f.error("Error while reading from database",r)}}async getPopupECommerceEvents(e){const t=E(x.visitorUuid),r=(await pt.openEventsDatabaseConnection(__privateMethod(this,o,a))).transaction(He.UserActivityEvents,"readwrite").store.index(Ke.VisitorUuid),i=[];let n=await r.openCursor(IDBKeyRange.only(t));for(;n;){const{value:t}=n;if(e(t))i.push(t);n=await n.continue()}return i}},gt=new class{getStorage(){try{const e=localStorage.getItem("grPopupsServiceKey");return JSON.parse(e)}catch(e){f.error("Failed to get local storage data",e)}}getPopupEvents(){return ht.getEvents(C.Popup)}async getLastPopupImpression(e){var t;const r=(await this.getPopupEvents()).filter((t=>t.popupEvent===_e.Show&&t.popupId===e)).sort(((e,t)=>Date.parse(t.occurredOn)-Date.parse(e.occurredOn)));if(!(null==(t=r[0])?void 0:t.occurredOn))return null;else return new Date(r[0].occurredOn)}async getPopupImpressionsAmount(e){return(await this.getPopupEvents()).filter((t=>t.popupEvent===_e.Show&&t.popupId===e)).length}async hasPopupBeenClosedBefore(e){return(await this.getPopupEvents()).filter((t=>t.popupEvent===_e.Close&&t.popupId===e)).length>0}async hasPopupBeenSeenInSession(e){return(await this.getPopupEvents()).filter((t=>t.popupEvent===_e.Show&&t.popupId===e)).length>0}async hasPopupBeenSubmittedBefore(e){return(await this.getPopupEvents()).filter((t=>t.popupEvent===_e.Submit&&t.popupId===e)).length>0}_getPopupEventsFromLocalStorage(){var e,t;return null==(t=null==(e=this.getStorage())?void 0:e.events)?void 0:t.filter((e=>e.popupEvent===_e.Submit||_e.Close||_e.Show))}registerPopupClose(e){return this.addEventToStorage(Be.getPopupCloseEvent(e))}registerPopupSubmit(e){return this.addEventToStorage(Be.getPopupSubmitEvent(e))}registerPopupView(e){return this.addEventToStorage(Be.getPopupShowEvent(e))}async migrateData(){if(!localStorage.getItem("grPopupsMigration")){const e=this._getPopupEventsFromLocalStorage();if(e)await Promise.all(e.map(this.addEventToStorage)),localStorage.setItem("grPopupsServiceKey",JSON.stringify({})),localStorage.setItem("grPopupsMigration","true")}}addEventToStorage(e){return ht.saveEvent(e)}},vt=window.__grIntegrationConfig.cData.useNOStorage?new class{setGrid(e){this.grid=e}setAid(e){this.aid=e}async registerPopupClose(e){return this.addEventToStorage(Be.getPopupCloseEvent(e))}async registerPopupSubmit(e){return this.addEventToStorage(Be.getPopupSubmitEvent(e))}async registerPopupView(e){return this.addEventToStorage(Be.getPopupShowEvent(e))}hasPopupBeenSeenInSession(e){return this.getPopupActivityData(e).then((e=>!!e.lastImpressionOccurredAt))}addEventToStorage(e){return We.addPopupEventToStorage(e)}async getPopupActivityData(e){return We.getPopupActivityData(e)}getLastPopupImpression(e){return this.getPopupActivityData(e).then((e=>new Date(e.lastImpressionOccurredAt)))}hasPopupBeenClosedBefore(e){return this.getPopupActivityData(e).then((e=>e.closes>0))}hasPopupBeenSubmittedBefore(e){return this.getPopupActivityData(e).then((e=>e.submits>0))}getPopupImpressionsAmount(e){return this.getPopupActivityData(e).then((e=>e.impressions))}}:gt,wt="https://us-wbe.gr-cdn.com/dynamic/gr-popups.js",yt="https://",mt="http://",ft="www.";function Dt(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}class Et{constructor(e){this.url=e,this.enhancedUrls=[]}static create(e){return new Et(e)}withSlash(){if(!(this.url.endsWith("*")||this.url.endsWith("+")||this.url.includes("?")||this.url.endsWith("/")))this.url=`${this.url}/`;return this}withLackOfProtocolAndWww(){if(!this.url.startsWith("*")&&!this.hasProtocolIncluded()&&!this.hasWwwPart())this.enhancedUrls=[...this.enhancedUrls,`${yt}${this.url}`,`${mt}${this.url}`,`${yt}${ft}${this.url}`,`${mt}${ft}${this.url}`];return this}withLackOfWww(){if(this.url.startsWith("*"))return this;if(this.hasProtocolIncluded()&&!this.hasWwwPart())this.enhancedUrls=[...this.enhancedUrls,`${yt}${ft}${this.url.replace(/^(http:\/\/|https:\/\/)/,"")}`,`${mt}${ft}${this.url.replace(/^(http:\/\/|https:\/\/)/,"")}`];return this}withLackOfProtocol(){if(this.url.startsWith("*"))return this;if(!this.hasProtocolIncluded()&&this.hasWwwPart())this.enhancedUrls=[...this.enhancedUrls,`${yt}${this.url}`,`${mt}${this.url}`];return this}enhance(){return[...this.enhancedUrls,this.url]}hasProtocolIncluded(){return this.url.startsWith(yt)||this.url.startsWith(mt)}hasWwwPart(){return this.url.replace(/^(http:\/\/|https:\/\/)/,"").startsWith(ft)}}const Pt=1e3*60*60*24;c=new WeakMap;const It=Object.freeze({[p]:true,[h]:true}),St=Object.freeze({[p]:true}),bt=Object.freeze({}),Ct={[l.AwaitClick]:class extends w{constructor(){super(...arguments),this.type=l.AwaitClick,this.outs=_t.getNodeOutsInstance(l.AwaitClick)}async handler(){const{selector:e}=this.properties;try{return await this.waitForElementClick(e),p}catch(t){if(t instanceof d)return h;f.error(t)}}waitForElementClick(e){return new Promise(((t,r)=>{const i=document.querySelector(e),n=()=>{t(),this.cleanLeaveFalseTimeout()};if(i)i.addEventListener("click",n,{once:true}),this.waitForDelayLeaveFalse().then((()=>{i.removeEventListener("click",n),r(new d)}));else r(new g(e))}))}},[l.AwaitScroll]:class extends w{constructor(){super(...arguments),this.type=l.AwaitScroll,this.outs=_t.getNodeOutsInstance(l.AwaitScroll)}async handler(){const{selector:e,percent:t}=this.properties;try{if(e)await this.watchForElementIntersectWithViewport(e);else if(t)await this.watchForPagePercentValueIntersectsWithViewport(t);return p}catch(r){if(r instanceof d)return h;f.error(r)}finally{this.cleanLeaveFalseTimeout()}}watchForElementIntersectWithViewport(e){return new Promise(((t,r)=>{const i=document.querySelector(e);if(i){const e=new IntersectionObserver(((e,r)=>{for(const n of e)if(n.isIntersecting&&n.target===i)t(),r.disconnect()}));e.observe(i),this.waitForDelayLeaveFalse().then((()=>{e.disconnect(),r(new d)}))}else r(new g(e))}))}async watchForPagePercentValueIntersectsWithViewport(e){return new Promise(((t,r)=>{const i=document.documentElement.scrollHeight*(e/D);function n(){if(document.documentElement.clientHeight+document.documentElement.scrollTop>i)t(),document.removeEventListener("scroll",n)}if(document.documentElement.clientHeight+document.documentElement.scrollTop>i)t();else document.addEventListener("scroll",n,true);this.waitForDelayLeaveFalse().then((()=>{document.removeEventListener("scroll",n),r(new d)}))}))}},[l.AwaitExit]:class extends w{constructor(){super(...arguments),this.outs=_t.getNodeOutsInstance(l.AwaitExit),this.type=l.AwaitExit}handler(){return new Promise((e=>{const t=()=>{e(p),this.cleanLeaveFalseTimeout()};document.documentElement.addEventListener("mouseleave",t,{once:true}),this.waitForDelayLeaveFalse().then((()=>{document.documentElement.removeEventListener("mouseout",t),e(h)}))}))}},[l.AwaitInactivity]:class extends w{constructor(){super(...arguments),this.abortController=new AbortController,this.handlersMap={click:null,scroll:null,keydown:null,mousemove:null},this.type=l.AwaitInactivity,this.outs=_t.getNodeOutsInstance(l.AwaitInactivity)}handler(){const{inactivityTime:e}=this.properties;return new Promise((t=>{this.waitForDelayLeaveFalse().then((()=>{t(h)})),this.waitForUserActivity(e).then((()=>{t(p),this.cleanLeaveFalseTimeout()}))}))}async waitForUserActivity(e){const t=window.setTimeout((()=>{this.abortController.abort()}),e);try{return await Promise.race([this.waitForUserAction("scroll"),this.waitForUserAction("click"),this.waitForUserAction("keydown"),this.waitForUserAction("mousemove")]),window.clearTimeout(t),this.detachActivityMonitorHandlers(),this.waitForUserActivity(e)}catch(r){if(r instanceof j)return;window.clearTimeout(t),f.error(r)}}detachActivityMonitorHandlers(){const{click:e,keydown:t,scroll:r,mousemove:i}=this.handlersMap;document.removeEventListener("click",e),document.removeEventListener("scroll",r),document.removeEventListener("keydown",t),document.removeEventListener("mousemove",i),this.handlersMap={click:null,keydown:null,scroll:null,mousemove:null}}waitForUserAction(e){return new Promise(((t,r)=>{document.addEventListener(e,t,{once:true,capture:"scroll"===e}),this.handlersMap[e]=t,this.abortController.signal.addEventListener("abort",(()=>{r(new j)}),{once:true})}))}},[l.FilterSubscriber]:class extends v{constructor(){super(...arguments),this.type=l.FilterSubscriber,this.outs=_t.getNodeOutsInstance(l.FilterSubscriber)}async handler(){let e="1"===E("gaIsValuable");if(b.canUseBackendForSubscriberIdentification())try{e=(await B.getVisitorData()).isConfirmedIdentifiedVisitor}catch(t){f.error("Failed to load subscriber data",t)}return Promise.resolve(e?p:h)}},[l.FilterDevice]:class extends v{constructor(){super(...arguments),this.type=l.FilterDevice,this.outs=_t.getNodeOutsInstance(l.FilterDevice)}handler(){const{deviceType:e}=this.properties,t=this.detectDeviceType();if(e.includes(t))return Promise.resolve(p);else return Promise.resolve(h)}detectDeviceType(){const{userAgentData:e}=window.navigator;if(e){const{mobile:t}=e;if(t)return this.detectDeviceTypeByScreenWidth(true);else return q.Desktop}return this.detectDeviceTypeByScreenWidth()}detectDeviceTypeByScreenWidth(e){var t;const{availWidth:r,availHeight:i}=screen;let n=null==(t=screen.orientation)?void 0:t.type;if(!n)n=window.matchMedia("(orientation: landscape)").matches?"landscape":"portrait";const s=n.match(/landscape/)?i:r;if(Ee.Mobile>=s)return q.Mobile;else if(s>Ee.Mobile&&Ee.Tablet>=s)return q.Tablet;return e?q.Tablet:q.Desktop}},[l.FilterLocation]:class extends v{constructor(){super(...arguments),this.type=l.FilterLocation,this.outs=_t.getNodeOutsInstance(l.FilterLocation)}handler(){return new Promise((async e=>{let{locations:t}=this.properties;if(null==t?void 0:t.length){if(t=(Array.isArray(t)?t:[t]).map((e=>e.toLowerCase())),t.includes(z.All))return e(p),void 0;try{const r=(await Pe.getVisitorCountryCode()).toLowerCase();if(t.includes(r))e(p);else e(h)}catch(r){if(r.status===Ie)e(h);f.error(r)}}else e(p)}))}},[l.FilterUrl]:class extends v{constructor(){super(...arguments),this.type=l.FilterUrl,this.outs=_t.getNodeOutsInstance(l.FilterUrl)}handler(){const{urls:e}=this.properties;if(function(e,t){return(e=>e.map((e=>Et.create(e).withSlash().withLackOfProtocolAndWww().withLackOfProtocol().withLackOfWww().enhance())).flat(1))(t).some((t=>{const r=Array.from(t.matchAll(/[*+]/g));let i;if(r.length)i=r.reduce(((e,r,i,n)=>{var s;const o=[...e,Dt(t.substring(((null==(s=n[i-1])?void 0:s.index)??-1)+1,r.index)),"*"===r[0]?".*":"."];if(i===n.length-1)o.push(Dt(t.substring(r.index+1)));return o}),[]).join("");else i=Dt(t);return new RegExp(`^${i}$`).test((e=>{if(!e.includes("?")&&!e.endsWith("/"))return`${e}/`;else return e})(e))}))}(document.location.href,e))return Promise.resolve(p);else return Promise.resolve(h)}},[l.FilterTime]:class extends v{constructor(){super(...arguments),this.type=l.FilterTime,this.outs=_t.getNodeOutsInstance(l.FilterVisit)}handler(){const{beforeTime:e,afterTime:t}=this.properties,r=Date.now();let i=true,n=true;if(null===e&&null===t)return Promise.resolve(p);if(this.validateProperties(),e)i=e>r;if(t)n=r>t;if(i&&n)return Promise.resolve(p);else return Promise.resolve(h)}validateProperties(){const{afterTime:e,beforeTime:t}=this.properties,r="number"==typeof e,i="number"==typeof t;if(e&&!r||t&&!i||(r&&i?e>=t:false))throw new Se}},[l.FilterECommerceActivity]:class extends v{constructor(){super(...arguments),__privateAdd(this,c,void 0),this.type=l.FilterECommerceActivity,this.outs=_t.getNodeOutsInstance(l.FilterECommerceActivity),__privateSet(this,c,(e=>{const{conditions:{product:t,category:r}}=this.properties;if("object"==typeof(i=e)&&null!==i&&"eventType"in i&&i["eventType"]===C.ViewItem){const{data:{product:{id:r}}}=e;if(t===Z.AnyProduct)return true;else if(!(null==t?void 0:t.includes(r)))return false;return this.validateDateProperties(e)}var i;if((e=>"object"==typeof e&&null!==e&&"eventType"in e&&e["eventType"]===C.ViewCategory)(e)){const{data:{id:t}}=e;if(r===Z.AnyCategory)return true;else if(!(null==r?void 0:r.includes(t)))return false;return this.validateDateProperties(e)}return false}))}async handler(){const e=await ht.getPopupECommerceEvents(__privateGet(this,c));return this.validateAmountProperty(e)?p:h}validateDateProperties(e){const{conditions:{date:t}}=this.properties,{occurredOn:r}=e;if(t){const{name:e,value:i}=t;if(e===Q.LastDays)return new Date(r).getTime()>Date.now()-i*Pt;if(e===Q.DateRange){const{from:e,to:t}=i,n=new Date(r).getTime(),s=!e||new Date(e).getTime()<n,o=!t||n<new Date(t).getTime();return s&&o}return f.error(`Unknown date condition name: ${e} in ecommerce activity filter node`),false}return true}validateAmountProperty(e){const{conditions:{amount:t}}=this.properties;if(t){const{name:r,value:i}=t;switch(r){case X.Exactly:return i===e.length;case X.MoreThan:return e.length>i;case X.LessThan:return i>e.length;default:!(e=>{f.error(`Unsupported value: ${e}`)})(r)}}return e.length>0}},[l.FilterVisit]:class extends v{constructor(){super(...arguments),this.type=l.FilterVisit,this.outs=_t.getNodeOutsInstance(l.FilterVisit)}async handler(){if(!this.validateUrlPath())return h;const[e,t]=await Promise.all([this.validateFrequencyProperty(),this.validateVisitorsProperty()]);if(e&&t)return p;else return h}async validateFrequencyProperty(){const{frequency:e,frequencyDaysNumber:t=0}=this.properties;if(e===be.Session)return!Ce.hasUserVisitedPage();else if(e===be.OnceEveryDays){const e=await Me.getLastActivityDate();if(e)return W(e.getTime(),t)}return true}async validateVisitorsProperty(){const{visitors:e}=this.properties,t=await Me.isNewVisitor();switch(e){case G.New:return t;case G.Returning:return!t;default:return true}}validateUrlPath(){const{urlPath:e="*"}=this.properties;return qe(window.location.pathname,e)}},[l.FilterPopup]:class extends v{constructor(){super(...arguments),this.type=l.FilterPopup,this.outs=_t.getNodeOutsInstance(l.FilterPopup)}async handler(){const{popupId:e,showIfNotCloseBefore:t,showIfNotSubmittedBefore:r,showIfSeenLessThanAmount:i}=this.properties;if(!(await this.shouldPassFrequencyConditionCheck()))return h;if(t&&await vt.hasPopupBeenClosedBefore(e))return h;if(r&&await vt.hasPopupBeenSubmittedBefore(e))return h;if(i&&await vt.getPopupImpressionsAmount(e)>=i)return h;else return p}async shouldPassFrequencyConditionCheck(){const{showEveryDays:e,frequency:t,popupId:r}=this.properties;if("session"===t)return!(await vt.hasPopupBeenSeenInSession(r));if("everyDays"===t&&e){const t=await vt.getLastPopupImpression(r);if(t)return W(t.getTime(),e);else return true}return true}},[l.ReactScroll]:class extends v{constructor(){super(...arguments),this.type=l.ReactScroll,this.outs=_t.getNodeOutsInstance(l.ReactScroll)}handler(){const{selector:e}=this.properties,t=document.querySelector(e);if(t)return t.scrollIntoView({behavior:"smooth"}),Promise.resolve(p)}},[l.ReactRedirect]:class extends v{constructor(){super(...arguments),this.type=l.ReactRedirect,this.outs=_t.getNodeOutsInstance(l.ReactRedirect)}handler(){const{url:e}=this.properties;return window.location.assign(e),Promise.resolve(void 0)}},[l.ReactDelay]:class extends v{constructor(){super(...arguments),this.type=l.ReactDelay,this.outs=_t.getNodeOutsInstance(l.ReactDelay)}async handler(){const{delay:e}=this.properties;return await(t=e,new Promise((e=>{setTimeout(e,t)}))),p;var t}},[l.ReactPopup]:class extends v{constructor(){super(...arguments),this.type=l.ReactPopup,this.outs=_t.getNodeOutsInstance(l.ReactPopup)}async handler(){var e;const{env:t,id:r,mode:i}=this.properties;if(await this.attachPopupLibrary(),i===V.Inline)return null==(e=window.PopupsRenderer)?void 0:e.registerCustomElements(),p;if(window.PopupsRenderer){this.attachPopupEvents();try{await window.PopupsRenderer.renderPopupFromId(r,{env:window.PopupsRenderer.GeoEnvironment[t]})}catch(n){f.error(n)}return p}}attachPopupLibrary(){return new Promise(((e,t)=>{const r=document.createElement("script");r.src=b.getPopupRendererCustomUrl()??wt,r.async=true,r.addEventListener("load",e),r.addEventListener("error",t),document.head.appendChild(r)}))}attachPopupEvents(){window.PopupsRenderer.registerEventSubscriber((e=>{if(e instanceof window.PopupsRenderer.PopupEvents.Close)this.closePopupHandler();if(e instanceof window.PopupsRenderer.PopupEvents.BodyView)this.showPopupHandler();if(e instanceof window.PopupsRenderer.PopupEvents.FormLead)this.submitPopupHandler()}))}closePopupHandler(){vt.registerPopupClose(this.properties.id)}showPopupHandler(){vt.registerPopupView(this.properties.id)}submitPopupHandler(){vt.registerPopupSubmit(this.properties.id)}}},Tt={[l.AwaitClick]:It,[l.AwaitScroll]:It,[l.AwaitExit]:It,[l.AwaitInactivity]:It,[l.FilterUrl]:It,[l.FilterSubscriber]:It,[l.FilterDevice]:It,[l.FilterLocation]:It,[l.FilterECommerceActivity]:It,[l.FilterTime]:It,[l.FilterVisit]:It,[l.FilterPopup]:It,[l.ReactDelay]:St,[l.ReactScroll]:St,[l.ReactRedirect]:bt,[l.ReactPopup]:St};class _t{static getNodeInstance(e,t){return new Ct[e](t)}static getNodeOutsInstance(e){return Tt[e]}}class At{constructor(e){this.visitorPath=new u,this.webEventsFlowData=this.createWebFlowFromSerializedData(e)}initVisitorFlow(){this.findStartingElements().forEach((e=>{this.processFlow(e)}))}async processFlow(e){try{const t=await this.processNode(e);if(this.visitorPath.addEntry(e.id),t){const e=this.visitorPath.hasElementBeenVisited(t.id);if(!e||e&&t.isRecurrent)this.processFlow(t)}}catch(t){f.error(t)}}async processNode(e){const t=this.getNodeConnectedToNodes(e);f.log(`Processing node ${e.type} with id: ${e.id}`,e);const r=await e.handler();return f.log(`Finished processing node ${e.type} with id: ${e.id} with result ${r}`),t[r]}getNodeConnectedToNodes(e){return this.webEventsFlowData.connections.filter((t=>t.from===e.id)).reduce(((e,t)=>(e[t.fromPathKey]=this.webEventsFlowData.nodes.find((e=>e.id===t.to)),e)),{})}findStartingElements(){const{nodes:e,connections:t}=this.webEventsFlowData;return e.filter((e=>!t.some((t=>t.to===e.id))))}createWebFlowFromSerializedData(e){return{...e,nodes:e.nodes.map((e=>_t.getNodeInstance(e.type,{...e})))}}}class Ft{constructor(e){this.webEventFlowData=e,e.forEach((e=>{const t=new At(e);f.log("New web event workflow initialized with data",e),t.initVisitorFlow()}))}}let Lt=null;async function Vt(e){if(Ce.saveUserVisit(),await gt.migrateData(),null==e?void 0:e.length)if("complete"===window.document.readyState)Lt=new Ft(e);else window.addEventListener("load",(()=>{Lt=new Ft(e)}),{once:true})}e.init=e=>{if(b.isWebEventModuleInitialized())return;b.setWebEventModuleInitialized(),b.enablePopupDevMode();const t=JSON.parse(e).map((e=>{return"object"==typeof(t=e)&&null!==t&&"nodes"in t&&"connections"in t&&e;var t})).filter((e=>{var t;return null==(t=e.nodes)?void 0:t.length}));Vt(t),window.history.pushState=new Proxy(window.history.pushState,{apply(e,r,i){return Vt(t),e.apply(r,i)}}),window.history.replaceState=new Proxy(window.history.replaceState,{apply(e,r,i){if(3===i.length&&!!i[2])Vt(t);return e.apply(r,i)}}),window.addEventListener("popstate",(()=>{Vt(t)}))},Object.defineProperties(e,{__esModule:{value:true},[Symbol.toStringTag]:{value:"Module"}})}((e="undefined"!=typeof globalThis?globalThis:e||self).GRWE={})}(this);
